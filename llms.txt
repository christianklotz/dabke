# dabke

> Scheduling library powered by constraint programming (CP-SAT)

---

## Schedule Definition

### defineSchedule

Define a complete schedule configuration. Returns a `ScheduleDefinition` whose
`createSchedulerConfig()` method produces a `ModelBuilderConfig` for the solver.

```typescript
import {
  defineSchedule, t, time, cover, shift,
  maxHoursPerDay, maxHoursPerWeek, minRestBetweenShifts,
  weekdays, weekend,
} from "dabke";

export default defineSchedule({
  roles: ["waiter", "runner", "manager"],
  skills: ["senior"],

  times: {
    lunch: time({ start: t(12), end: t(15) }),
    dinner: time(
      { start: t(17), end: t(21) },
      { start: t(18), end: t(22), dayOfWeek: weekend },
    ),
  },

  coverage: [
    cover("lunch", "waiter", 2),
    cover("dinner", "waiter", 4, { dayOfWeek: weekdays }),
    cover("dinner", "waiter", 6, { dayOfWeek: weekend }),
  ],

  shiftPatterns: [
    shift("morning", t(11, 30), t(15)),
    shift("evening", t(17), t(22)),
  ],

  rules: [
    maxHoursPerDay(10),
    maxHoursPerWeek(48),
    minRestBetweenShifts(10),
  ],
});
```

**Parameters:**
- `config` - Schedule configuration object with:
  - `roles` (required): declared role names (string array)
  - `skills` (optional): declared skill names (string array)
  - `times` (required): named semantic time periods (see `time()`)
  - `coverage` (required): staffing requirements (see `cover()`)
  - `shiftPatterns` (required): available shifts (see `shift()`)
  - `rules` (optional): constraints and preferences (see rule functions)
  - `dayOfWeek` (optional): days the business operates (inclusion filter)
  - `weekStartsOn` (optional): defaults to `"monday"`

**Returns:** `ScheduleDefinition`

---

## Primitives

### t(hours, minutes?)

Create a `TimeOfDay` value.

```typescript
t(9)        // 9:00 AM
t(17, 30)   // 5:30 PM
```

### weekdays

Constant: `["monday", "tuesday", "wednesday", "thursday", "friday"]`

### weekend

Constant: `["saturday", "sunday"]`

---

## Semantic Times

### time(...entries)

Define a named semantic time period. Each entry has `start`, `end`, and optional
`dayOfWeek` or `dates` scoping. Entries without scoping are the default.

```typescript
times: {
  // Simple: same times every day
  lunch: time({ start: t(12), end: t(15) }),

  // Variants: different times on weekends
  dinner: time(
    { start: t(17), end: t(21) },
    { start: t(18), end: t(22), dayOfWeek: weekend },
  ),

  // Point-in-time window (keyholder at opening)
  opening: time({ start: t(8, 30), end: t(9) }),
}
```

**Entry fields:**
- `start` (required): `TimeOfDay` - when this period starts
- `end` (required): `TimeOfDay` - when this period ends
- `dayOfWeek` (optional): scope to specific days of the week
- `dates` (optional): scope to specific dates (YYYY-MM-DD strings)

---

## Coverage

### cover(timeName, target, count, options?)

Define a staffing requirement: how many people are needed during a semantic time.

```typescript
coverage: [
  // 2 waiters during lunch
  cover("lunch", "waiter", 2),

  // 1 manager OR supervisor during dinner
  cover("dinner", ["manager", "supervisor"], 1),

  // 1 person with keyholder skill at opening
  cover("opening", "keyholder", 1),

  // 1 senior waiter (role + skill AND)
  cover("lunch", "waiter", 1, { skills: ["senior"] }),

  // Different counts by day
  cover("lunch", "waiter", 2, { dayOfWeek: weekdays }),
  cover("lunch", "waiter", 3, { dayOfWeek: weekend }),
]
```

**Parameters:**
- `timeName` - name of a semantic time defined in `times`
- `target` - role name (string), array of role names (OR logic), or skill name
- `count` - how many people needed
- `options` (optional):
  - `skills`: skill names required in addition to the role (AND logic)
  - `dayOfWeek`: scope to specific days
  - `dates`: scope to specific dates (YYYY-MM-DD)
  - `priority`: `"MANDATORY"` | `"HIGH"` | `"MEDIUM"` | `"LOW"` (default: `"MANDATORY"`)

**IMPORTANT: Entries for the same time and role STACK additively.**
For weekday vs weekend staffing, use mutually exclusive `dayOfWeek` on BOTH entries.

---

## Shift Patterns

### shift(id, startTime, endTime, options?)

Define a shift pattern: a time slot available for employee assignment.

```typescript
shiftPatterns: [
  shift("morning", t(11, 30), t(15)),
  shift("evening", t(17), t(22)),

  // Role-restricted shift
  shift("kitchen", t(6), t(14), { roles: ["chef", "prep_cook"] }),

  // Day-restricted shift
  shift("saturday_short", t(9), t(14), { dayOfWeek: ["saturday"] }),

  // Location-specific shift
  shift("terrace_lunch", t(12), t(16), { locationId: "terrace" }),
]
```

**Parameters:**
- `id` - unique shift identifier
- `startTime` - shift start (`TimeOfDay`)
- `endTime` - shift end (`TimeOfDay`)
- `options` (optional):
  - `roles`: restrict which roles can be assigned to this shift
  - `dayOfWeek`: restrict which days this shift is available
  - `locationId`: physical location for this shift

---

## Rules

Each rule is a function call. Default priority is `"MANDATORY"`.
Use `appliesTo` to scope to a role, skill, or member ID.
Use time scoping options (`dayOfWeek`, `dateRange`, `dates`) to limit when the rule applies.

### maxHoursPerDay(hours, options?)

Limits hours per day.

```typescript
maxHoursPerDay(10)
maxHoursPerDay(4, { appliesTo: "student", dayOfWeek: weekdays })
```

### maxHoursPerWeek(hours, options?)

Limits hours per scheduling week.

```typescript
maxHoursPerWeek(48)
maxHoursPerWeek(20, { appliesTo: "student" })
```

### minHoursPerDay(hours, options?)

Minimum hours when assigned on a day.

```typescript
minHoursPerDay(4)
```

### minHoursPerWeek(hours, options?)

Minimum hours per scheduling week.

```typescript
minHoursPerWeek(20, { priority: "HIGH" })
```

### maxShiftsPerDay(shifts, options?)

Maximum distinct shifts per day.

```typescript
maxShiftsPerDay(1)
maxShiftsPerDay(2, { appliesTo: "student", dayOfWeek: weekend })
```

### maxConsecutiveDays(days, options?)

Maximum consecutive working days.

```typescript
maxConsecutiveDays(5)
```

### minConsecutiveDays(days, options?)

Once working, continue for at least this many consecutive days.

```typescript
minConsecutiveDays(2, { priority: "HIGH" })
```

### minRestBetweenShifts(hours, options?)

Minimum rest hours between shifts.

```typescript
minRestBetweenShifts(10)
```

### preference(level, options?)

Prefer (`"high"`) or avoid (`"low"`) assigning.
Requires `appliesTo`.

```typescript
preference("high", { appliesTo: "waiter" })
preference("low", { appliesTo: "student", dayOfWeek: weekdays })
```

### preferLocation(locationId, options?)

Prefer assigning to shifts at a specific location.
Requires `appliesTo`.

```typescript
preferLocation("terrace", { appliesTo: "alice" })
```

### timeOff(options)

Block assignments during specified periods.
Requires at least one time scope (`dayOfWeek`, `dateRange`, `dates`, or `from`/`until`).

```typescript
// Full days off
timeOff({ appliesTo: "alice", dateRange: { start: "2024-02-01", end: "2024-02-05" } })

// Every weekend off
timeOff({ appliesTo: "mauro", dayOfWeek: weekend })

// Wednesday afternoons off
timeOff({ appliesTo: "student", dayOfWeek: ["wednesday"], from: t(14) })
```

### assignTogether(memberIds, options?)

Members work the same shifts on days they are both assigned.

```typescript
assignTogether(["alice", "bob"])
assignTogether(["alice", "bob", "charlie"], { priority: "HIGH" })
```

### Common rule options

All rules accept:
- `priority`: `"MANDATORY"` | `"HIGH"` | `"MEDIUM"` | `"LOW"` (default: `"MANDATORY"`)
- `appliesTo`: role name, skill name, member ID, or array of these
- `dayOfWeek`: scope to specific days
- `dateRange`: `{ start: "YYYY-MM-DD", end: "YYYY-MM-DD" }`
- `dates`: specific date strings

Not all rules support all scoping options. Entity-only rules (e.g., `maxConsecutiveDays`)
ignore time scoping.

---

## Supporting Types

### TimeOfDay

Time of day (24-hour format).

```typescript
{ hours: number, minutes?: number }
```

### DayOfWeek

```typescript
"monday" | "tuesday" | "wednesday" | "thursday" | "friday" | "saturday" | "sunday"
```

### Priority

```typescript
"LOW" | "MEDIUM" | "HIGH" | "MANDATORY"
```
